name: ðŸ³ Build and Push Multi-Arch Docker Image

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      tag:
        description: 'é•œåƒç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.5)'
        required: true
        default: '1.0.5'
  
  # è‡ªåŠ¨è§¦å‘
  push:
    # å½“åˆ›å»ºtagæ—¶è§¦å‘
    tags:
      - 'v*'
    # å½“Dockerfileæˆ–ç›¸å…³æ–‡ä»¶è¢«ä¿®æ”¹æ—¶è§¦å‘ï¼ˆå¯é€‰ï¼‰
    branches:
      - main
      - master
    paths:
      - 'Dockerfile'
      - 'Dockerfile-cn'
      - 'requirements.txt'
      - '.github/workflows/docker-build.yml'

jobs:
  build-and-push:
    name: ðŸ—ï¸ Build Multi-Arch Docker Images
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        include:
          # å›½é™…ç‰ˆ (Docker Hub)
          - dockerfile: Dockerfile
            registry: docker.io
            image_name: zhinianboke/xianyu-auto-reply
            tag_suffix: ''
          
          # å›½å†…ç‰ˆ (é˜¿é‡Œäº‘)
          - dockerfile: Dockerfile-cn
            registry: registry.cn-shanghai.aliyuncs.com
            image_name: zhinian-software/xianyu-auto-reply
            tag_suffix: '-cn'
    
    steps:
    - name: ðŸ“¥ Checkoutä»£ç 
      uses: actions/checkout@v4
    
    - name: ðŸ”§ è®¾ç½®QEMU (ARMæ¨¡æ‹Ÿ)
      uses: docker/setup-qemu-action@v3
      with:
        platforms: linux/amd64,linux/arm64
    
    - name: ðŸ”§ è®¾ç½®Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        install: true
        platforms: linux/amd64,linux/arm64
    
    - name: ðŸ” ç™»å½•Docker Hub
      if: matrix.registry == 'docker.io'
      uses: docker/login-action@v3
      with:
        registry: docker.io
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    
    - name: ðŸ” ç™»å½•é˜¿é‡Œäº‘é•œåƒä»“åº“
      if: matrix.registry == 'registry.cn-shanghai.aliyuncs.com'
      uses: docker/login-action@v3
      with:
        registry: registry.cn-shanghai.aliyuncs.com
        username: ${{ secrets.ALIYUN_USERNAME }}
        password: ${{ secrets.ALIYUN_TOKEN }}
    
    - name: ðŸ“ æå–å…ƒæ•°æ®
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ matrix.registry }}/${{ matrix.image_name }}
        tags: |
          # ä»Žtagæå–ç‰ˆæœ¬å·: v1.0.5 -> 1.0.5
          type=semver,pattern={{version}}
          # ä»Žæ‰‹åŠ¨è¾“å…¥æå–
          type=raw,value=${{ github.event.inputs.tag }},enable=${{ github.event_name == 'workflow_dispatch' }}
          # latestæ ‡ç­¾
          type=raw,value=latest
    
    - name: ðŸ—ï¸ æž„å»ºå¹¶æŽ¨é€å¤šæž¶æž„é•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ${{ matrix.dockerfile }}
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          BUILDTIME=${{ github.event.head_commit.timestamp }}
          VERSION=${{ steps.meta.outputs.version }}
    
    - name: ðŸ“Š è¾“å‡ºé•œåƒä¿¡æ¯
      run: |
        echo "========================================="
        echo "âœ… é•œåƒæž„å»ºæˆåŠŸï¼"
        echo "========================================="
        echo "é•œåƒä»“åº“: ${{ matrix.registry }}"
        echo "é•œåƒåç§°: ${{ matrix.image_name }}"
        echo "æ”¯æŒæž¶æž„: linux/amd64, linux/arm64"
        echo ""
        echo "ðŸ“¦ é•œåƒæ ‡ç­¾:"
        echo "${{ steps.meta.outputs.tags }}"
        echo ""
        echo "ðŸš€ ä½¿ç”¨æ–¹æ³•:"
        echo "docker pull ${{ matrix.registry }}/${{ matrix.image_name }}:latest"
        echo "========================================="

  # æµ‹è¯•å¤šæž¶æž„é•œåƒ
  test-images:
    name: ðŸ§ª Test Multi-Arch Images
    needs: build-and-push
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        platform: [linux/amd64, linux/arm64]
        registry: 
          - registry.cn-shanghai.aliyuncs.com/zhinian-software/xianyu-auto-reply
    
    steps:
    - name: ðŸ”§ è®¾ç½®QEMU
      uses: docker/setup-qemu-action@v3
      with:
        platforms: ${{ matrix.platform }}
    
    - name: ðŸ§ª æµ‹è¯•é•œåƒ
      run: |
        echo "æµ‹è¯•å¹³å°: ${{ matrix.platform }}"
        docker run --rm --platform ${{ matrix.platform }} \
          ${{ matrix.registry }}:latest \
          python --version || true
        
        docker run --rm --platform ${{ matrix.platform }} \
          ${{ matrix.registry }}:latest \
          python -c "import sys; print(f'Python {sys.version}')" || true

  # åˆ›å»ºReleaseè¯´æ˜Ž
  create-release-notes:
    name: ðŸ“ Create Release Notes
    needs: [build-and-push, test-images]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: ðŸ“¥ Checkoutä»£ç 
      uses: actions/checkout@v4
    
    - name: ðŸ“ ç”ŸæˆReleaseè¯´æ˜Ž
      id: release_notes
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        cat > release_notes.md << EOF
        # ðŸ³ Dockeré•œåƒå‘å¸ƒ - v${VERSION}
        
        ## ðŸ“¦ é•œåƒä¿¡æ¯
        
        ### å›½é™…ç‰ˆ (Docker Hub)
        \`\`\`bash
        docker pull zhinianboke/xianyu-auto-reply:${VERSION}
        docker pull zhinianboke/xianyu-auto-reply:latest
        \`\`\`
        
        ### å›½å†…ç‰ˆ (é˜¿é‡Œäº‘)
        \`\`\`bash
        docker pull registry.cn-shanghai.aliyuncs.com/zhinian-software/xianyu-auto-reply:${VERSION}
        docker pull registry.cn-shanghai.aliyuncs.com/zhinian-software/xianyu-auto-reply:latest
        \`\`\`
        
        ## ðŸ–¥ï¸ æ”¯æŒçš„æž¶æž„
        
        - âœ… **linux/amd64** - Intel/AMDå¤„ç†å™¨
        - âœ… **linux/arm64** - ARM64å¤„ç†å™¨
        
        ## ðŸš€ å¿«é€Ÿå¯åŠ¨
        
        ### x86_64æœåŠ¡å™¨
        \`\`\`bash
        docker run -d -p 8080:8080 --restart always \\
          -v \$PWD/xianyu-auto-reply/:/app/data/ \\
          --name xianyu-auto-reply \\
          registry.cn-shanghai.aliyuncs.com/zhinian-software/xianyu-auto-reply:${VERSION}
        \`\`\`
        
        ### ARM64æœåŠ¡å™¨
        \`\`\`bash
        docker run -d -p 8080:8080 --restart always \\
          --platform linux/arm64 \\
          -v \$PWD/xianyu-auto-reply/:/app/data/ \\
          --name xianyu-auto-reply \\
          registry.cn-shanghai.aliyuncs.com/zhinian-software/xianyu-auto-reply:${VERSION}
        \`\`\`
        
        ## ðŸ“‹ æ›´æ–°å†…å®¹
        
        æŸ¥çœ‹ [CHANGELOG.md](./CHANGELOG.md) äº†è§£è¯¦ç»†æ›´æ–°å†…å®¹ã€‚
        
        ## ðŸ” éªŒè¯é•œåƒ
        
        \`\`\`bash
        # æ£€æŸ¥é•œåƒæž¶æž„
        docker manifest inspect registry.cn-shanghai.aliyuncs.com/zhinian-software/xianyu-auto-reply:${VERSION}
        
        # æµ‹è¯•è¿è¡Œ
        docker run --rm registry.cn-shanghai.aliyuncs.com/zhinian-software/xianyu-auto-reply:${VERSION} python --version
        \`\`\`
        
        ## ðŸ’¡ é€‚ç”¨åœºæ™¯
        
        ### x86_64 (amd64)
        - ä¼ ç»ŸæœåŠ¡å™¨å’ŒVPS
        - é˜¿é‡Œäº‘ã€è…¾è®¯äº‘ã€åŽä¸ºäº‘æ ‡å‡†å®žä¾‹
        - æœ¬åœ°PCå’Œè™šæ‹Ÿæœº
        
        ### ARM64 (aarch64)
        - Oracle Cloud - Ampere A1 (æ°¸ä¹…å…è´¹)
        - AWS Graviton2/3å®žä¾‹
        - é˜¿é‡Œäº‘å€šå¤©710å®žä¾‹
        - æ ‘èŽ“æ´¾4/5
        - Apple Mç³»åˆ—èŠ¯ç‰‡ (é€šè¿‡Docker Desktop)
        
        ---
        
        **æž„å»ºæ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        **Gitæäº¤**: ${GITHUB_SHA}
        EOF
        
        cat release_notes.md
    
    - name: ðŸ’¾ åˆ›å»ºRelease
      uses: softprops/action-gh-release@v1
      with:
        body_path: release_notes.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

